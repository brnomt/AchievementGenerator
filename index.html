<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Logros de Minecraft</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <h1>Generador de Logros</h1>

    <div class="app-layout">
        
        <!-- Panel Izquierdo: Configuración -->
        <div class="panel config-panel">
            
            <div class="input-group">
                <label for="topText">Texto Superior</label>
                <div class="text-controls">
                    <input type="text" id="topText" value="¡Logro obtenido!">
                    <select id="topColorSelect" title="Color de Minecraft"></select>
                    <input type="color" id="topColorPicker" value="#FFFF55" title="Color Personalizado">
                </div>
            </div>

            <div class="input-group">
                <label for="bottomText">Texto Inferior</label>
                <div class="text-controls">
                    <input type="text" id="bottomText" value="Madera Nueva">
                    <select id="bottomColorSelect" title="Color de Minecraft"></select>
                    <input type="color" id="bottomColorPicker" value="#FFFFFF" title="Color Personalizado">
                </div>
            </div>

            <div class="preview-area">
                <canvas id="canvas" width="320" height="64" style="display: block; max-width: 100%; height: auto; image-rendering: pixelated;"></canvas>
            </div>

            <button onclick="window.downloadImage()">Descargar PNG</button>
        </div>

        <!-- Panel Derecho: Selector de Íconos -->
        <div class="panel icon-panel">
            <h3>Seleccionar Ícono</h3>
            <input type="text" id="iconGridSearch" class="icon-search-bar" placeholder="Buscar ícono..." autocomplete="off">
            
            <div id="iconGrid" class="icon-grid">
                <!-- Se llena con JS -->
            </div>

            <div class="custom-upload-group">
                <label for="customIconInput">Subir textura personalizada:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="customIconInput" accept="image/*">
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { items } from './src/items.js';

        // Elementos DOM
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const topTextInput = document.getElementById('topText');
        const bottomTextInput = document.getElementById('bottomText');
        
        const iconGrid = document.getElementById('iconGrid');
        const iconSearch = document.getElementById('iconGridSearch');
        const customIconInput = document.getElementById('customIconInput');

        // Color Controls
        const topColorSelect = document.getElementById('topColorSelect');
        const topColorPicker = document.getElementById('topColorPicker');
        const bottomColorSelect = document.getElementById('bottomColorSelect');
        const bottomColorPicker = document.getElementById('bottomColorPicker');

        // Estado
        // Buscamos un icono inicial válido (Grass_Block o el primero de la lista)
        const initialItem = items.find(i => i.id === 'Grass_Block') || items[0];
        let currentIconData = initialItem;
        const fontName = 'Minecraftia'; 
        
        // Colores Minecraft
        const mcColors = {
            'yellow': { name: 'Amarillo', hex: '#FFFF55' },
            'white': { name: 'Blanco', hex: '#FFFFFF' },
            'gold': { name: 'Oro', hex: '#FFAA00' },
            'green': { name: 'Verde', hex: '#55FF55' },
            'dark_green': { name: 'Verde Oscuro', hex: '#00AA00' },
            'red': { name: 'Rojo', hex: '#FF5555' },
            'dark_red': { name: 'Rojo Oscuro', hex: '#AA0000' },
            'aqua': { name: 'Aqua', hex: '#55FFFF' },
            'dark_aqua': { name: 'Aqua Oscuro', hex: '#00AAAA' },
            'blue': { name: 'Azul', hex: '#5555FF' },
            'dark_blue': { name: 'Azul Oscuro', hex: '#0000AA' },
            'light_purple': { name: 'Rosa', hex: '#FF55FF' },
            'dark_purple': { name: 'Morado', hex: '#AA00AA' },
            'gray': { name: 'Gris', hex: '#AAAAAA' },
            'dark_gray': { name: 'Gris Oscuro', hex: '#555555' },
            'black': { name: 'Negro', hex: '#000000' }
        };

        // Cargar Imágenes Globales
        const bgImage = new Image();
        bgImage.src = 'assets/Logro3.png';
        bgImage.onload = () => draw();
        bgImage.onerror = () => console.warn("Fondo no encontrado.");

        const iconImage = new Image();
        iconImage.onload = () => draw();

        // --- Inicialización ---

        function setupColorControl(select, picker, defaultKey) {
            for (const [key, val] of Object.entries(mcColors)) {
                const option = document.createElement('option');
                option.value = val.hex;
                option.textContent = val.name;
                if (key === defaultKey) option.selected = true;
                select.appendChild(option);
            }
            const customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.textContent = 'Personalizado';
            select.appendChild(customOpt);

            if (mcColors[defaultKey]) picker.value = mcColors[defaultKey].hex;

            select.addEventListener('change', () => {
                if (select.value !== 'custom') picker.value = select.value;
                draw();
            });
            picker.addEventListener('input', () => {
                select.value = 'custom';
                draw();
            });
        }

        setupColorControl(topColorSelect, topColorPicker, 'yellow');
        setupColorControl(bottomColorSelect, bottomColorPicker, 'white');


        // --- Lógica del Grid de Iconos ---

        function formatName(id) {
            // El ID ya viene con mayúsculas de los archivos
            return id.replace(/_/g, ' ');
        }

        function renderGrid(filter = "") {
            iconGrid.innerHTML = '';
            const lowerFilter = filter.toLowerCase();
            
            // Filtrar items
            const filteredItems = items.filter(item => {
                return item.id.toLowerCase().includes(lowerFilter) || formatName(item.id).toLowerCase().includes(lowerFilter);
            }).slice(0, 500); // Limitamos a 500 para rendimiento de renderizado inicial

            // Renderizar items
            filteredItems.forEach(item => {
                const slot = document.createElement('div');
                slot.className = `icon-slot ${item.id === currentIconData?.id ? 'selected' : ''}`;
                slot.title = formatName(item.id);
                slot.dataset.id = item.id;
                
                const img = document.createElement('img');
                img.src = `assets/icons2/${item.id}.${item.ext}`;
                img.alt = item.id;
                img.loading = 'lazy';
                
                slot.appendChild(img);
                
                slot.addEventListener('click', () => {
                    selectIcon(item);
                });

                iconGrid.appendChild(slot);
            });
        }

        function selectIcon(item) {
            currentIconData = item;
            // Update visual selection
            document.querySelectorAll('.icon-slot').forEach(el => el.classList.remove('selected'));
            const active = document.querySelector(`.icon-slot[data-id="${item.id}"]`);
            if(active) active.classList.add('selected');
            
            // Load image
            iconImage.src = `assets/icons2/${item.id}.${item.ext}`;
        }

        // Búsqueda en Grid
        iconSearch.addEventListener('input', (e) => {
            renderGrid(e.target.value);
        });

        // Carga Custom Icon
        customIconInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    iconImage.src = evt.target.result;
                    document.querySelectorAll('.icon-slot').forEach(el => el.classList.remove('selected'));
                    currentIconData = { id: 'custom' };
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Dibujado ---
        function draw() {
            const width = 320;
            const height = 64;
            canvas.width = width;
            canvas.height = height;
            ctx.clearRect(0, 0, width, height);

            // Fondo
            if (bgImage.complete && bgImage.naturalWidth > 0) {
                ctx.drawImage(bgImage, 0, 0, width, height);
            } else {
                ctx.fillStyle = '#212121';
                ctx.fillRect(0, 0, width, height);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(0, 0, width, height);
                ctx.fillStyle = '#333333';
                ctx.fillRect(2, 2, width-4, height-4);
            }

            // Icono
            const iconSize = 32; 
            const iconX = 16;
            const iconY = (height - iconSize) / 2;
            
            if (iconImage.complete && iconImage.naturalWidth > 0) {
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(iconImage, iconX, iconY, iconSize, iconSize);
            }

            // Texto
            const textX = 60;
            ctx.font = `12px "${fontName}", "Press Start 2P", monospace`;
            ctx.textBaseline = 'top';
            
            // Top Text
            ctx.fillStyle = topColorPicker.value;
            ctx.shadowColor = "#000000"; 
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            ctx.fillText(topTextInput.value, textX, 24);

            // Bottom Text
            ctx.fillStyle = bottomColorPicker.value;
            ctx.fillText(bottomTextInput.value, textX, 44);
            
            ctx.shadowColor = "transparent";
        }

        window.downloadImage = function() {
            try {
                const link = document.createElement('a');
                link.download = 'logro-minecraft.png';
                link.href = canvas.toDataURL();
                link.click();
            } catch (e) {
                alert("Error al descargar. Use un servidor local.");
            }
        };

        // Listeners
        topTextInput.addEventListener('input', draw);
        bottomTextInput.addEventListener('input', draw);
        
        // Init
        document.fonts.ready.then(draw);
        renderGrid(); 
        if (currentIconData) {
            iconImage.src = `assets/icons2/${currentIconData.id}.${currentIconData.ext}`;
        }

    </script>
</body>
</html>